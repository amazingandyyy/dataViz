<!doctype html>

<html>

<head>
  <link rel="stylesheet" href="https://openlayers.org/en/v3.20.1/css/ol.css" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.3/d3.min.js"></script>
  <script src="https://openlayers.org/en/v3.20.1/build/ol.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>

  <style>
    circle {
      fill: rgba(255,255,255,0.2);
      user-select: none;
      -webkit-user-select: none;
    }
    circle:hover { 
        stroke: white;
        stroke-width: 0.5px;
      }
    svg {
      border: 1px solid black;
      background: black;
    }
    .d3-tip {
        font-family: 'Helvetica';
        font-size: 1em;
        line-height: 1;
        padding: 7px 10px;
        background: rgba(255,255,255,0.5);
        color: black;
        border-radius: 1px;
      }
  </style>
</head>

<body>
    
    <!--<div id="map" class="map"></div>-->
    <!--<script type="text/javascript">
      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([-122.41, 37.82]),
          zoom: 12
        })
      });
    </script>-->

  <script type="text/javascript">
    const outerWidth = 960;
    const outerHeight = 500;
    const margin = {left: -100, right: -100, bottom: 0, top: 30};
    const innerWidth = outerWidth - margin.left - margin.right;
    const innerHeight = outerHeight - margin.top - margin.bottom;

    let xAxis = 'longitude';
    let yAxis = 'latitude';
    let rAxis = 'population';
    
    let rMin = 0.2;
    let rMax = 10;

    let svg = d3.select('body').append('svg')
      .attr('width', outerWidth)
      .attr('height', outerHeight);

    let g = svg.append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`)
      .call(d3.zoom()
        .scaleExtent([1, 100])
        .on('zoom', zoomed))
    
    let xScale = d3.scaleLinear().range([0, outerWidth - margin.left - margin.right]);
    let yScale = d3.scaleLinear().range([outerHeight - margin.top - margin.bottom, 0]);
    let rScale = d3.scaleSqrt().range([rMin, rMax]);

    function zoomed(){
      g.attr("transform", d3.event.transform)
    }

    var tip = d3.tip()
        .attr("class", "d3-tip")
        .offset([-10, 0])
        .html(function(d) {
          return d.name + ": " + d.population;
        });

    g.call(tip);
    
    function render(data) {
  
      let circles = g.selectAll('circle').data(data)

      xScale.domain(d3.extent(data, d=>d[xAxis]));
      yScale.domain(d3.extent(data, d=>d[yAxis]));
      rScale.domain(d3.extent(data, d=>d[rAxis]));
  
      circles.exit().remove()
  
      circles.enter().append('circle')
        .on('mouseover', tip.show)
        .on('mouseout', tip.hide)
        .merge(circles)
        .attr('r',  d => rScale(d.population))
        .attr('cx', d => xScale(d.longitude))
        .attr('cy', d => yScale(d.latitude))
  
    }
  
    function type(d) {
      d.latitude = +d.latitude;
      d.longitude = +d.longitude;
      d.population = +d.population;
      return d;
    }
  
    d3.csv('cities.csv', type, render);
      
  </script>
</body>

</html>